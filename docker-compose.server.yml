services:
  orthanc:
    image: jodogne/orthanc-plugins
    command: /run/secrets/orthanc.json
    # IMPORTANT: Do not expose Orthanc publicly on a central server.
    # Trainer access: SSH port-forward to localhost:8042 if needed.
    ports:
      - "127.0.0.1:4242:4242"
      - "127.0.0.1:8042:8042"
    environment:
      ORTHANC_NAME: "ORTHANC"
    volumes:
      - ./orthanc/orthanc.json:/run/secrets/orthanc.json:ro
      - ./orthanc-db:/var/lib/orthanc/db
      - ./worklists:/var/lib/orthanc/worklists
    restart: unless-stopped

  simulator:
    build: ./simulator
    expose:
      - "5000"
    volumes:
      - ./worklists:/app/worklists
      - ./simulator-data:/app/data
    environment:
      ORTHANC_url: "http://orthanc:8042"
      ORTHANC_DICOM_HOST: "orthanc"
      ORTHANC_DICOM_PORT: "4242"
      # If Orthanc is exposed via Caddy on a hostname, the simulator can auto-link it over HTTPS.
      ORTHANC_DOMAIN: "${ORTHANC_DOMAIN:-}"
      # Generates N SuS codes on first startup if none exist yet
      AUTO_GENERATE_SESSIONS: "${AUTO_GENERATE_SESSIONS:-20}"
      # Set this in your server environment (see docs/deploy-central-server.md)
      FLASK_SECRET_KEY: "${FLASK_SECRET_KEY}"
      # Enables /admin for generating SuS session codes
      # Preferred: bcrypt (same format as `caddy hash-password`)
      ADMIN_USER: "${ADMIN_USER:-admin}"
      ADMIN_PASSHASH: "${ADMIN_PASSHASH:-}"
      # Legacy (plaintext) fallback; prefer ADMIN_PASSHASH
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:-}"
      # Leave empty by default on central server (Orthanc not publicly linked)
      ORTHANC_PUBLIC_URL: "${ORTHANC_PUBLIC_URL}"
    depends_on:
      - orthanc
    restart: unless-stopped

  caddy:
    image: caddy:2
    ports:
      - "80:80"
      - "443:443"
    environment:
      # Public hostname for the simulator (e.g. sim.example.org)
      SIM_DOMAIN: "${SIM_DOMAIN:-localhost}"
      # Optional: reverse-proxy Orthanc behind Caddy on a separate hostname.
      # Defaults are chosen to be safe and to keep Caddy from failing to start
      # if variables are not configured.
      ORTHANC_DOMAIN: "${ORTHANC_DOMAIN:-orthanc.localhost}"
      # Basic Auth in front of Orthanc (shared credentials)
      ORTHANC_PROXY_USER: "${ORTHANC_PROXY_USER:-admin}"
      # Default hash = unknown long random password. Replace via .env on server.
      ORTHANC_PROXY_PASSHASH: "${ORTHANC_PROXY_PASSHASH:-$$2a$$14$$lezIDF0dmUgYxcMC6gdwk.vyrGseRycf3NJWlhsltfsW5QHhbLvIC}"
    volumes:
      - ./deploy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - simulator
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
