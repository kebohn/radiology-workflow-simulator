<!DOCTYPE html>
<html lang="de">
<head>
    <title>Radiologie Workflow Simulator</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; }
        .section { background: #f0f0f0; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .workflow { background: #fff; border: 1px solid #cfd8dc; padding: 12px; margin-bottom: 20px; border-radius: 5px; }
        .workflow small { color: #546e7a; }
        .workflow-steps { color: #546e7a; font-weight: 400; font-size: 0.85em; }
        .workflow-diagram { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eceff1; flex: 1 1 auto; min-height: 0; overflow: auto; }
        .workflow-diagram svg { width: 100%; height: auto; }
        .workflow-drawer-toggle { position: absolute; left: -9999px; }
        .workflow-drawer-button {
            position: fixed;
            right: 0;
            top: 140px;
            z-index: 100;
            background: #fff;
            border: 1px solid #cfd8dc;
            border-right: none;
            padding: 10px 12px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .workflow-drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
                width: min(520px, 90vw);
            z-index: 99;
            background: #fff;
            border-left: 1px solid #cfd8dc;
            padding: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateX(105%);
            transition: transform 160ms ease-in-out;
        }
        .workflow-drawer header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid #eceff1;
            padding-bottom: 8px;
            margin-bottom: 8px;
            flex: 0 0 auto;
        }
        .workflow-drawer-title { font-weight: 700; }
        .workflow-drawer-close {
            cursor: pointer;
            border: 1px solid #cfd8dc;
            padding: 4px 8px;
            border-radius: 6px;
            background: #fff;
        }
        #workflowDrawer:checked ~ .workflow-drawer { transform: translateX(0); }
        h2 { margin-top: 0; }
        label { display: block; margin-bottom: 5px; }
        input { margin-bottom: 10px; width: 100%; max-width: 100%; padding: 8px; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; cursor: pointer; max-width: 100%; white-space: normal; }
        button:hover { background: #0056b3; }
        .success { color: green; font-weight: bold; padding: 10px; background: #e8f5e9; border: 1px solid green; margin-bottom: 20px;}
        .protocol-note { font-size: 0.85em; color: #666; font-style: italic; margin-top: 5px; }

        .tile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; width: 100%; }
        .tile { background: #fff; border: 1px solid #cfd8dc; border-radius: 10px; padding: 12px; min-width: 0; }
        .tile h3 { margin: 0 0 6px 0; font-size: 1.05em; }
        .tile p { margin-top: 0; }
        .tile .tile-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start; }
        .tile .tile-actions button { white-space: nowrap; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

        @media (max-width: 520px) {
            body { padding: 12px; }
            .workflow-drawer-button { top: 96px; }
        }

        @media (max-width: 620px) {
            .tile-grid { grid-template-columns: 1fr; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
            mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
    </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const checkbox = document.getElementById('workflowDrawer');
                if (!checkbox) return;
                const storageKey = 'workflowDrawerOpen';
                checkbox.checked = localStorage.getItem(storageKey) === '1';
                checkbox.addEventListener('change', () => {
                    localStorage.setItem(storageKey, checkbox.checked ? '1' : '0');
                });
            });
        </script>
        <script>
            function renderWorkflow(activeNode, nextNode) {
                const base = document.getElementById('workflowGraphBase');
                const mermaidDiv = document.getElementById('workflowMermaid');
                if (!base || !mermaidDiv || !window.mermaid) return;

                let highlight = '';
                if (activeNode) highlight += `\n  class ${activeNode} active`;
                if (nextNode) highlight += `\n  class ${nextNode} next`;

                mermaidDiv.removeAttribute('data-processed');
                mermaidDiv.innerHTML = base.innerHTML.trim() + highlight + "\n";

                try {
                    if (typeof window.mermaid.run === 'function') {
                        window.mermaid.run({ nodes: [mermaidDiv] });
                    } else if (typeof window.mermaid.init === 'function') {
                        window.mermaid.init(undefined, mermaidDiv);
                    }
                } catch (e) {
                    // Ignore rendering errors; the UI still works without the diagram.
                }
            }

            function workflowExplain(nodeId) {
                const explain = {
                    KIS: { title: 'KIS', text: 'Patientenaufnahme / Stammdaten. Von hier kommen typischerweise HL7 ADT Events.' },
                    LIS: { title: 'LIS', text: 'Labor-System. Liefert z.B. Kreatinin als HL7 ORU Resultat.' },
                    RIS: { title: 'RIS', text: 'Radiologie-Informationssystem. Auftrag/Order (HL7 ORM) und Worklist.' },
                    MWLServer: { title: 'MWL', text: 'DICOM Modality Worklist (SCP). Modalitäten fragen hier die Arbeitsliste ab.' },
                    Modality: { title: 'CT', text: 'Modalität (CT Konsole). Ruft MWL ab und sendet Bilder via DICOM C-STORE.' },
                    PACS: { title: 'PACS', text: 'PACS/Archiv. Speichert DICOM und liefert Query/Retrieve.' },
                    Workstation: { title: 'Workstation', text: 'Befundungs-Workstation. Sucht Studien (C-FIND) und holt sie (C-MOVE).' },
                    ADT: { title: '1. HL7 ADT', text: 'ADT = Aufnahme/Patientenstammdaten (Admission/Discharge/Transfer).' },
                    ORU: { title: '2. HL7 ORU', text: 'ORU = Befund/Resultat (Observation Result). Hier: Kreatinin aus dem LIS.' },
                    ORM: { title: '3. HL7 ORM', text: 'ORM = Auftrag/Order (Order Message). Hier: RIS erstellt radiologischen Auftrag.' },
                    MWL: { title: '4. DICOM C-FIND (MWL)', text: 'CT fragt geplante Untersuchungen ab (Worklist Pull).' },
                    STORE: { title: '5. DICOM C-STORE', text: 'Modalität sendet Bilder/Instanzen an das PACS.' },
                    QFIND: { title: '6. DICOM C-FIND (Study)', text: 'Workstation sucht Studien im PACS (Study Root Query).' },
                    CMOVE: { title: '7. DICOM C-MOVE', text: 'Workstation holt Studie. PACS sendet Instanzen an den Empfänger (Store SCP).' },
                };

                const key = String(nodeId || '').trim();
                const info = explain[key];
                const panel = document.getElementById('workflowExplainPanel');
                if (!panel) return;

                if (!info) {
                    panel.style.display = 'none';
                    panel.innerHTML = '';
                    return;
                }

                panel.style.display = 'block';
                panel.innerHTML = `<div style="font-weight:700; margin-bottom:4px;">${info.title}</div><div>${info.text}</div>`;

                const checkbox = document.getElementById('workflowDrawer');
                if (checkbox) checkbox.checked = true;
                try { localStorage.setItem('workflowDrawerOpen', '1'); } catch (e) {}
            }

            function workflowTraceAdd(currentText, nextText, activeNode, nextNode) {
                const entry = {
                    ts: new Date().toISOString(),
                    page: window.location.pathname + window.location.search,
                    cur: currentText || '',
                    nxt: nextText || '',
                    a: activeNode || '',
                    n: nextNode || '',
                };

                try {
                    const key = 'workflowTrace';
                    const raw = localStorage.getItem(key);
                    const list = raw ? JSON.parse(raw) : [];
                    const last = Array.isArray(list) && list.length ? list[list.length - 1] : null;
                    const same = last && last.cur === entry.cur && last.nxt === entry.nxt && last.a === entry.a && last.n === entry.n && last.page === entry.page;
                    if (!same) {
                        const next = Array.isArray(list) ? list : [];
                        next.push(entry);
                        while (next.length > 20) next.shift();
                        localStorage.setItem(key, JSON.stringify(next));
                    }
                } catch (e) {
                    // ignore
                }
            }

            function workflowTraceRender() {
                const host = document.getElementById('workflowTrace');
                if (!host) return;
                let list = [];
                try {
                    const raw = localStorage.getItem('workflowTrace');
                    list = raw ? JSON.parse(raw) : [];
                } catch (e) {
                    list = [];
                }
                if (!Array.isArray(list) || list.length === 0) {
                    host.innerHTML = '<div style="color:#546e7a; font-size:0.85em;">Noch keine Events.</div>';
                    return;
                }

                const items = list.slice(-10).reverse();
                host.innerHTML = items.map((it) => {
                    const when = (it.ts || '').replace('T', ' ').slice(0, 19);
                    const label = `${when} — ${it.cur || '—'} → ${it.nxt || '—'}`;
                    const href = it.page || '/';
                    return `<button type="button" data-href="${href}" style="width:100%; text-align:left; border:1px solid #cfd8dc; background:#fff; border-radius:8px; padding:6px 8px; margin:4px 0; cursor:pointer;">${label}</button>`;
                }).join('');

                host.querySelectorAll('button[data-href]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const href = btn.getAttribute('data-href');
                        if (href) window.location.href = href;
                    });
                });
            }

            function workflowBindStepButtons() {
                const map = {
                    '1': '/',
                    '2': '/',
                    '3': '/',
                    '4': '/modality',
                    '5': '/modality',
                    '6': '/viewer',
                    '7': '/viewer',
                };
                document.querySelectorAll('[data-wf-step]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const step = btn.getAttribute('data-wf-step') || '';
                        const href = map[step] || '/';
                        try { localStorage.setItem('workflowDrawerOpen', '1'); } catch (e) {}
                        window.location.href = href;
                    });
                });
            }

            function setWorkflowUi(currentText, nextText, activeNode, nextNode) {
                const steps = document.getElementById('workflowSteps');
                if (steps) {
                    steps.textContent = `Aktuell: ${currentText || '—'} | Als nächstes: ${nextText || '—'}`;
                }
                renderWorkflow(activeNode, nextNode);
                workflowTraceAdd(currentText, nextText, activeNode, nextNode);
                workflowTraceRender();
            }
        </script>
</head>
<body>
    <h1>Radiologie Workflow Simulator</h1>

    <div class="section">
        <h2>SuS Session (zentraler Server)</h2>
        <p class="protocol-note">Setzen Sie hier Ihren SuS-Code. Dann werden PID/Accession intern mit diesem Prefix versehen und die Workstation zeigt standardmässig nur Studien mit diesem Prefix (soft isolation).</p>
        <form action="/set_student" method="post" style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start;">
            <input type="text" name="student_code" placeholder="z.B. SUS17" value="{{ student_code }}" style="margin-bottom:0; flex: 1 1 220px; min-width: 180px;">
            <button type="submit" style="white-space:nowrap;">SuS-Code setzen</button>
        </form>
        {% if student_code %}
        <form action="/clear_student" method="post" style="margin-top:8px;">
            <button type="submit" style="background:#757575;">SuS-Code löschen</button>
        </form>
        {% endif %}
    </div>
    
    {% if msg %}
    <div class="success">{{ msg }}</div>
    {% endif %}

    <input id="workflowDrawer" class="workflow-drawer-toggle" type="checkbox">
    <label class="workflow-drawer-button" for="workflowDrawer">Workflow</label>
    <aside class="workflow-drawer" aria-label="Workflow">
        <header>
            <div>
                <div class="workflow-drawer-title">Workflow</div>
                <div id="workflowSteps" class="workflow-steps">Aktuell: {{ workflow_current or '—' }} | Als nächstes: {{ workflow_next or '—' }}</div>
            </div>
            <label class="workflow-drawer-close" for="workflowDrawer">Schliessen</label>
        </header>
        <div class="workflow-diagram">
                        <template id="workflowGraphBase">
flowchart TB
    classDef system fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000
    classDef backend fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef hl7 fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef dicom fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef active stroke:#000,stroke-width:4px
    classDef next stroke-dasharray: 6 3

    KIS["KIS"]
    RIS["RIS"]
    LIS["LIS"]
    MWLServer["MWL"]
    Modality["CT"]
    PACS["PACS"]
    Workstation["Workstation"]

    ADT["1. HL7 ADT"]
    ORU["2. HL7 ORU"]
    ORM["3. HL7 ORM"]
    MWL["4. DICOM C-FIND (MWL)"]
    STORE["5. DICOM C-STORE"]
    QFIND["6. DICOM C-FIND (Study)"]
    CMOVE["7. DICOM C-MOVE"]

    class KIS,RIS,LIS,Modality,Workstation system
    class MWLServer,PACS backend
    class ADT,ORU,ORM hl7
    class MWL,STORE,QFIND,CMOVE dicom

    KIS -.-> ADT -.-> RIS
    RIS -.-> ORU -.-> LIS
    RIS -.-> ORM -.-> MWLServer
    MWLServer --> MWL --> Modality
    Modality --> STORE --> PACS
    Workstation --> QFIND --> PACS
    Workstation --> CMOVE --> PACS

    click KIS workflowExplain "KIS"
    click RIS workflowExplain "RIS"
    click LIS workflowExplain "LIS"
    click MWLServer workflowExplain "MWL"
    click Modality workflowExplain "CT"
    click PACS workflowExplain "PACS"
    click Workstation workflowExplain "Workstation"
    click ADT workflowExplain "HL7 ADT"
    click ORU workflowExplain "HL7 ORU"
    click ORM workflowExplain "HL7 ORM"
    click MWL workflowExplain "DICOM MWL"
    click STORE workflowExplain "DICOM C-STORE"
    click QFIND workflowExplain "DICOM C-FIND"
    click CMOVE workflowExplain "DICOM C-MOVE"
                        </template>

                        <div id="workflowMermaid" class="mermaid"></div>

                        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;">
                            <button type="button" data-wf-step="1" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">1</button>
                            <button type="button" data-wf-step="2" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">2</button>
                            <button type="button" data-wf-step="3" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">3</button>
                            <button type="button" data-wf-step="4" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">4</button>
                            <button type="button" data-wf-step="5" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">5</button>
                            <button type="button" data-wf-step="6" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">6</button>
                            <button type="button" data-wf-step="7" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">7</button>
                        </div>

                        <div id="workflowExplainPanel" style="display:none; margin-top:10px; padding:10px; border-radius:10px; border:1px solid #eceff1; background:#fafafa;"></div>

                        <div style="margin-top:10px;">
                            <div style="font-weight:700; margin-bottom:6px;">Trace</div>
                            <div id="workflowTrace"></div>
                        </div>

                        <script type="application/json" id="workflowStateJson">{{ {'current': workflow_current or '', 'next': workflow_next or ''}|tojson }}</script>
                        <script>
                            document.addEventListener('DOMContentLoaded', () => {
                                workflowBindStepButtons();
                                workflowTraceRender();
                                const stateEl = document.getElementById('workflowStateJson');
                                const state = stateEl ? JSON.parse(stateEl.textContent || '{}') : { current: '', next: '' };
                                const cur = String(state.current || '');
                                const nxt = String(state.next || '');

                                if (cur.includes('LIS') || cur.includes('ORU') || cur.toLowerCase().includes('kreatinin')) {
                                    setWorkflowUi(cur || '2. HL7 ORU', nxt || '3. HL7 ORM', 'ORU', 'ORM');
                                } else if (cur.includes('RIS') || cur.includes('ORM') || cur.toLowerCase().includes('auftrag')) {
                                    setWorkflowUi(cur || '3. HL7 ORM', nxt || '4. DICOM C-FIND (MWL)', 'ORM', 'MWL');
                                } else {
                                    setWorkflowUi(cur || '1. HL7 ADT', nxt || '2. HL7 ORU', 'ADT', 'ORU');
                                }
                            });
                        </script>
        </div>
        <small>Hinweis: Das Diagramm wird im Browser gerendert (Mermaid). Wenn Sie offline sind, kann es sein, dass das Diagramm nicht angezeigt wird.</small>
    </aside>

    <div class="section">
        <h2>System-Check (DICOM C-ECHO)</h2>
        <p>Prüfen Sie, ob das PACS erreichbar ist ("Ping").</p>
        <form action="/echo" method="post">
            <button type="submit" style="background: #28a745;">Verbindung testen (C-ECHO)</button>
        </form>
        <div class="protocol-note">
            ℹ️ <strong>Hintergrund:</strong> Der <code>DICOM C-ECHO</code> Dienste ("Verification Service Class") wird verwendet, um die TCP/IP-Verbindung und die DICOM-Aushandlung (Association) zu testen. Das ist oft der erste Schritt bei der Fehlersuche.
        </div>
    </div>

    <div class="section">
        <h2>1. Verwaltung (HL7): KIS, LIS, RIS</h2>
        <p>In der Praxis sind <strong>KIS</strong> (Patientenaufnahme), <strong>LIS</strong> (Labor) und <strong>RIS</strong> (Radiologie-Auftrag) getrennte Systeme. Hier folgt der Ablauf bewusst strikt: erst Patient im KIS erfassen (HL7 ADT), dann RIS → LIS Anfrage, dann Auftrag im RIS (HL7 ORM).</p>
        
        <script>
        function _selectedPatient() {
            const sel = document.getElementById('risPatientSelect');
            if (!sel) return null;
            const opt = sel.options[sel.selectedIndex];
            if (!opt) return null;
            const pid = (sel.value || '').trim();
            const name = (opt.getAttribute('data-name') || '').trim();
            if (!pid) return null;
            return { pid, name };
        }

        function bindPatientSelect() {
            const sel = document.getElementById('risPatientSelect');
            if (!sel) return;
            const pidInput = document.getElementById('orderPid');
            const nameInput = document.getElementById('orderName');

            function apply() {
                const p = _selectedPatient();
                if (!p) {
                    if (pidInput) pidInput.value = '';
                    if (nameInput) nameInput.value = '';
                    return;
                }
                if (pidInput) pidInput.value = p.pid;
                if (nameInput) nameInput.value = p.name;
            }

            sel.addEventListener('change', apply);
            apply();
        }

        async function risRequestLis() {
            const p = _selectedPatient();
            const statusDiv = document.getElementById('lisStatus');
            const reqDiv = document.getElementById('lisHl7Request');
            const resDiv = document.getElementById('lisHl7Response');

            if (!p) { alert('Bitte zuerst einen erfassten Patienten auswählen (KIS).'); return; }
            if (!statusDiv || !reqDiv || !resDiv) return;

            statusDiv.innerHTML = '⏳ RIS → LIS Anfrage senden...';
            reqDiv.style.display = 'none';
            resDiv.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('pid', p.pid);

                const response = await fetch('/query_lis', { method: 'POST', body: formData });
                const data = await response.json();

                if (!response.ok || !data.ok) {
                    statusDiv.innerText = '❌ ' + (data.error || 'Fehler beim LIS Abruf');
                    return;
                }

                let html = `<strong>Ergebnis LIS (Labor):</strong><br>`;
                html += `PID: <span class="mono">${data.pid}</span><br>`;
                html += `Kreatinin: <span style="color:${data.color}; font-weight:bold; font-size:1.2em;">${data.value} ${data.unit}</span>`;
                html += `<br>Status: <span style="color:${data.color}">${data.status}</span>`;

                statusDiv.innerHTML = html;
                statusDiv.style.borderLeft = `5px solid ${data.color}`;
                statusDiv.style.paddingLeft = '10px';

                reqDiv.style.display = 'block';
                resDiv.style.display = 'block';
                reqDiv.innerText = 'Gesendete HL7 Nachricht (RIS → LIS):\n' + (data.raw_request_hl7 || '');
                resDiv.innerText = 'Empfangene HL7 Nachricht (LIS → RIS):\n' + (data.raw_hl7 || '');

                // Workflow: ORU/ORM highlight
                localStorage.setItem('workflowDrawerOpen', '1');
                setWorkflowUi('2. RIS → LIS: Kreatinin anfordern (HL7)', '3. RIS: Auftrag freigeben (HL7 ORM)', 'ORU', 'ORM');
            } catch (e) {
                statusDiv.innerText = '❌ Fehler beim LIS Abruf: ' + e;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            bindPatientSelect();
        });
        </script>

        <div class="tile-grid">
            <div class="tile">
                <h3>KIS: Patientenaufnahme (HL7 ADT)</h3>
                <p class="protocol-note">Zuerst Stammdaten erfassen. Das löst ein <code>HL7 ADT</code> Event aus (sichtbar als Roh-Nachricht).</p>

                <form action="/kis/register_patient" method="post">
                    <label>Patientenname:</label>
                    <input type="text" name="name" placeholder="z.B. MUSTERMAN^MAX" required>

                    <label>Patienten-ID (PID):</label>
                    <input type="text" name="pid" placeholder="z.B. 123456" required>

                    <div class="tile-actions">
                        <button type="submit" style="background: #0d6efd;">Patient erfassen (ADT)</button>
                        <button type="button" onclick="window.location='/'" style="background:#455a64;">Aktualisieren</button>
                    </div>
                </form>

                {% if last_adt_hl7 %}
                    <div class="protocol-note" style="margin-top: 10px;">Letzte HL7 ADT Nachricht:</div>
                    <pre style="background:#333; color:#0f0; padding:10px; border-radius:8px; font-size:0.8em; overflow-x:auto;">{{ last_adt_hl7 }}</pre>
                {% endif %}

                <div class="protocol-note" style="margin-top: 10px;">Erfasste Patienten (mit Aktualisieren neu laden):</div>
                {% if patients and patients|length > 0 %}
                    <table style="margin-top:6px;">
                        <thead>
                            <tr>
                                <th>PID</th>
                                <th>Name</th>
                                <th>Zeit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in patients %}
                                <tr>
                                    <td class="mono">{{ p.pid }}</td>
                                    <td>{{ p.name }}</td>
                                    <td class="mono">{{ p.updated_at or p.created_at }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="protocol-note">Noch keine Patienten erfasst.</div>
                {% endif %}
            </div>

            <div class="tile">
                <h3>RIS: Anfrage an LIS (HL7)</h3>
                <p class="protocol-note">Nachdem der Patient erfasst ist, sendet das RIS eine Anfrage ans LIS. Das LIS antwortet mit einem Labor-Resultat (HL7 ORU).</p>

                <label>Patient auswählen (aus KIS):</label>
                <select id="risPatientSelect" style="width:100%; padding:8px; margin-bottom:10px;">
                    <option value="">— Bitte wählen —</option>
                    {% for p in patients or [] %}
                        <option value="{{ p.pid }}" data-name="{{ p.name }}">{{ p.pid }} — {{ p.name }}</option>
                    {% endfor %}
                </select>

                <div class="tile-actions" style="margin-bottom: 10px;">
                    <button type="button" onclick="risRequestLis()" style="background: #6f42c1;">RIS → LIS: Kreatinin anfordern</button>
                </div>

                <div id="lisStatus" class="mono" style="margin-bottom: 10px;">
                    {% if last_lis_summary %}
                        <strong>Letztes Ergebnis LIS (Labor):</strong><br>
                        PID: <span class="mono">{{ last_lis_summary.pid }}</span><br>
                        Kreatinin: <span style="color:{{ last_lis_summary.color }}; font-weight:bold; font-size:1.2em;">{{ last_lis_summary.value }} {{ last_lis_summary.unit }}</span><br>
                        Status: <span style="color:{{ last_lis_summary.color }}">{{ last_lis_summary.status }}</span>
                    {% endif %}
                </div>

                <pre id="lisHl7Request" style="display:{% if last_lis_request_hl7 %}block{% else %}none{% endif %}; background:#333; color:#0f0; padding:10px; border-radius:8px; font-size:0.8em; overflow-x:auto;">{% if last_lis_request_hl7 %}Gesendete HL7 Nachricht (RIS → LIS):
{{ last_lis_request_hl7 }}{% endif %}</pre>

                <pre id="lisHl7Response" style="display:{% if last_oru_hl7 %}block{% else %}none{% endif %}; background:#333; color:#0f0; padding:10px; border-radius:8px; font-size:0.8em; overflow-x:auto; margin-top:8px;">{% if last_oru_hl7 %}Empfangene HL7 Nachricht (LIS → RIS):
{{ last_oru_hl7 }}{% endif %}</pre>
            </div>

            <div class="tile">
                <h3>RIS: Auftrag (HL7 ORM)</h3>
                <p class="protocol-note">Auftrag freigeben und Worklist-Eintrag erzeugen (nach dem Laborwert).</p>

                <form action="/create_order" method="post">
                    <label>Patientenname:</label>
                    <input type="text" id="orderName" name="name" placeholder="wird aus Auswahl übernommen" required>

                    <label>Patienten-ID (PID):</label>
                    <input type="text" id="orderPid" name="pid" placeholder="wird aus Auswahl übernommen" required>

                    <label>Auftragsnummer (Accession Number):</label>
                    <input type="text" name="acc" placeholder="z.B. ACC001" required>

                    <label>Untersuchungsbeschreibung:</label>
                    <input type="text" name="desc" value="CT Abdomen mit KM" required>

                    <button type="submit">RIS: Auftrag freigeben (HL7 ORM) + Worklist erstellen</button>
                </form>
            </div>
        </div>

        <div class="protocol-note" style="margin-top: 10px;">
            ℹ️ <strong>Hintergrund:</strong> Vor Kontrastmittel-Gabe (KM) muss die Nierenfunktion geprüft werden. Das RIS sendet eine Anfrage ans LIS und erhält ein Resultat (HL7 ORU). Erst danach wird der Auftrag (<code>HL7 ORM</code>) freigegeben.
        </div>
    </div>

    <div class="section">
        <h2>2-4. Durchführung</h2>
        <div class="tile-grid">
            <div class="tile">
                <h3>2. Modalität (CT Konsole)</h3>
                <p>Gehen Sie zur Konsole des CT-Scanners. Der Scanner wird die Arbeitsliste vom RIS abfragen und die Bilder erzeugen.</p>
                <a href="/modality"><button>CT Konsole öffnen</button></a>
                <div class="protocol-note">
                    ℹ️ <strong>Hintergrund:</strong> Die Modalität nutzt <code>DICOM C-FIND</code>, um geplante Untersuchungen abzurufen ("Worklist Pull").
                </div>
            </div>

            <div class="tile">
                <h3>3. Radiologe: Workstation (Query/Retrieve)</h3>
                <p>Simulieren Sie den Radiologen, der Bilder aus dem PACS abruft ("Pull").</p>
                <a href="/viewer"><button style="background: #388e3c;">Workstation öffnen</button></a>
                <div class="protocol-note">
                    ℹ️ <strong>Hintergrund:</strong> Hier demonstriert der Simulator <code>DICOM C-MOVE</code>. Die Workstation fordert das PACS auf, Bilder zu senden.
                </div>
            </div>

            <div class="tile">
                <h3>4. PACS Viewer & Import</h3>
                <p>Betrachten Sie die gespeicherten Bilder im Orthanc PACS oder importieren Sie echte DICOM-Dateien.</p>
                <div style="margin-bottom: 10px;">
                    <a href="/pacs"><button style="background: #1565c0;">PACS (SuS) öffnen (gefiltert)</button></a>
                </div>
                {% if orthanc_public_url %}
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <a href="{{ orthanc_public_url }}" target="_blank"><button>Orthanc PACS öffnen</button></a>
                        <a href="{{ orthanc_public_url }}/app/explorer.html#upload" target="_blank"><button style="background: #e65100;">DICOM Daten hochladen</button></a>
                    </div>
                    <p class="protocol-note"><small>Hinweis: Wenn Orthanc über Caddy geschützt ist, fragt der Browser nach dem Basic-Auth Login.</small></p>
                {% else %}
                    <p class="protocol-note">Hinweis: Auf einem zentralen Server ist Orthanc meist nicht öffentlich verlinkt. (Trainer-Zugriff z.B. per SSH Port-Forwarding.)</p>
                {% endif %}
                <div class="protocol-note">
                    ℹ️ <strong>Hintergrund:</strong> Über die Weboberfläche nutzt Orthanc <code>DICOMWEB (RESTful API)</code> für Uploads. In der Praxis senden Modalitäten jedoch meist direkt via <code>C-STORE</code>.
                </div>
            </div>
        </div>
    </div>
</body>
</html>
