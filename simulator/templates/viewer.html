<!DOCTYPE html>
<html lang="de">
<head>
    <title>Radiologie Befundungs-Arbeitsplatz</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .section { background: #e8f5e9; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .workflow { background: #fff; border: 1px solid #cfd8dc; padding: 12px; margin-bottom: 20px; border-radius: 5px; }
        .workflow small { color: #546e7a; }
        .workflow-steps { color: #546e7a; font-weight: 400; font-size: 0.85em; }
        .workflow-diagram { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eceff1; flex: 1 1 auto; min-height: 0; overflow: auto; }
        .workflow-diagram svg { width: 100%; height: auto; }
        .workflow-drawer-toggle { position: absolute; left: -9999px; }
        .workflow-drawer-button {
            position: fixed;
            right: 0;
            top: 140px;
            z-index: 100;
            background: #fff;
            border: 1px solid #cfd8dc;
            border-right: none;
            padding: 10px 12px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .workflow-drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(520px, 90vw);
            z-index: 99;
            background: #fff;
            border-left: 1px solid #cfd8dc;
            padding: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateX(105%);
            transition: transform 160ms ease-in-out;
        }
        .workflow-drawer header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid #eceff1;
            padding-bottom: 8px;
            margin-bottom: 8px;
            flex: 0 0 auto;
        }
        .workflow-drawer-title { font-weight: 700; }
        .workflow-drawer-close {
            cursor: pointer;
            border: 1px solid #cfd8dc;
            padding: 4px 8px;
            border-radius: 6px;
            background: #fff;
        }
        #workflowDrawer:checked ~ .workflow-drawer { transform: translateX(0); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white;}
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #388e3c; color: white; }
        button { background: #388e3c; color: white; border: none; padding: 8px 12px; cursor: pointer; }
        button:hover { background: #1b5e20; }
        .back-btn { background: #757575; margin-bottom: 20px; padding: 10px 15px; text-decoration: none; display: inline-block; color: white;}
        .protocol-note { font-size: 0.85em; color: #455a64; font-style: italic; margin-top: 10px; }
        .cache { background: #fff3e0; border: 1px solid #ff9800; }
        .cache th { background: #ff9800; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
            mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
    </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const checkbox = document.getElementById('workflowDrawer');
                if (!checkbox) return;
                const storageKey = 'workflowDrawerOpen';
                checkbox.checked = localStorage.getItem(storageKey) === '1';
                checkbox.addEventListener('change', () => {
                    localStorage.setItem(storageKey, checkbox.checked ? '1' : '0');
                });
            });
        </script>
        <script>
            function renderWorkflow(activeNode, nextNode) {
                const base = document.getElementById('workflowGraphBase');
                const mermaidDiv = document.getElementById('workflowMermaid');
                if (!base || !mermaidDiv || !window.mermaid) return;

                let highlight = '';
                if (activeNode) highlight += `\n  class ${activeNode} active`;
                if (nextNode) highlight += `\n  class ${nextNode} next`;

                mermaidDiv.removeAttribute('data-processed');
                mermaidDiv.innerHTML = base.innerHTML.trim() + highlight + "\n";

                try {
                    if (typeof window.mermaid.run === 'function') {
                        window.mermaid.run({ nodes: [mermaidDiv] });
                    } else if (typeof window.mermaid.init === 'function') {
                        window.mermaid.init(undefined, mermaidDiv);
                    }
                } catch (e) {
                    // Ignore rendering errors; the UI still works without the diagram.
                }
            }

            function setWorkflowUi(currentText, nextText, activeNode, nextNode) {
                const steps = document.getElementById('workflowSteps');
                if (steps) {
                    steps.textContent = `Aktuell: ${currentText || '—'} | Als nächstes: ${nextText || '—'}`;
                }
                renderWorkflow(activeNode, nextNode);
            }

            function workflowExplain(nodeId) {
                const explain = {
                    KIS: { title: 'KIS', text: 'Patientenaufnahme / Stammdaten. Von hier kommen typischerweise HL7 ADT Events.' },
                    LIS: { title: 'LIS', text: 'Labor-System. Liefert z.B. Kreatinin als HL7 ORU Resultat.' },
                    RIS: { title: 'RIS', text: 'Radiologie-Informationssystem. Auftrag/Order (HL7 ORM) und Worklist.' },
                    MWLServer: { title: 'MWL', text: 'DICOM Modality Worklist (SCP). Modalitäten fragen hier die Arbeitsliste ab.' },
                    Modality: { title: 'CT', text: 'Modalität (CT Konsole). Ruft MWL ab und sendet Bilder via DICOM C-STORE.' },
                    PACS: { title: 'PACS', text: 'PACS/Archiv. Speichert DICOM und liefert Query/Retrieve.' },
                    Workstation: { title: 'Workstation', text: 'Befundungs-Workstation. Sucht Studien (C-FIND) und holt sie (C-MOVE).' },
                    ADT: { title: '1. HL7 ADT', text: 'ADT = Aufnahme/Patientenstammdaten (Admission/Discharge/Transfer).' },
                    ORU: { title: '2. HL7 ORU', text: 'ORU = Befund/Resultat (Observation Result).' },
                    ORM: { title: '3. HL7 ORM', text: 'ORM = Auftrag/Order (Order Message).' },
                    MWL: { title: '4. DICOM C-FIND (MWL)', text: 'CT fragt geplante Untersuchungen ab (Worklist Pull).' },
                    STORE: { title: '5. DICOM C-STORE', text: 'Modalität sendet Bilder/Instanzen an das PACS.' },
                    QFIND: { title: '6. DICOM C-FIND (Study)', text: 'Workstation sucht Studien im PACS (Study Root Query).' },
                    CMOVE: { title: '7. DICOM C-MOVE', text: 'Workstation holt Studie. PACS sendet Instanzen an den Empfänger (Store SCP).' },
                };

                const key = String(nodeId || '').trim();
                const info = explain[key];
                const panel = document.getElementById('workflowExplainPanel');
                if (!panel) return;

                if (!info) {
                    panel.style.display = 'none';
                    panel.innerHTML = '';
                    return;
                }

                panel.style.display = 'block';
                panel.innerHTML = `<div style="font-weight:700; margin-bottom:4px;">${info.title}</div><div>${info.text}</div>`;

                const checkbox = document.getElementById('workflowDrawer');
                if (checkbox) checkbox.checked = true;
                try { localStorage.setItem('workflowDrawerOpen', '1'); } catch (e) {}
            }

            function workflowTraceAdd(currentText, nextText, activeNode, nextNode) {
                const postToGetMap = {
                    '/set_student': '/',
                    '/kis/register_patient': '/',
                    '/create_order': '/',
                    '/echo': '/',
                    '/retrieve': '/viewer',
                    '/workstation/report': '/viewer',
                };

                let safePage = window.location.pathname + window.location.search;
                if (postToGetMap[window.location.pathname]) {
                    safePage = postToGetMap[window.location.pathname];
                }

                const entry = {
                    ts: new Date().toISOString(),
                    page: safePage,
                    cur: currentText || '',
                    nxt: nextText || '',
                    a: activeNode || '',
                    n: nextNode || '',
                };

                try {
                    const key = 'workflowTrace';
                    const raw = localStorage.getItem(key);
                    const list = raw ? JSON.parse(raw) : [];
                    const last = Array.isArray(list) && list.length ? list[list.length - 1] : null;
                    const same = last && last.cur === entry.cur && last.nxt === entry.nxt && last.a === entry.a && last.n === entry.n && last.page === entry.page;
                    if (!same) {
                        const next = Array.isArray(list) ? list : [];
                        next.push(entry);
                        while (next.length > 20) next.shift();
                        localStorage.setItem(key, JSON.stringify(next));
                    }
                } catch (e) {
                    // ignore
                }
            }

            function workflowTraceRender() {
                const host = document.getElementById('workflowTrace');
                if (!host) return;
                let list = [];
                try {
                    const raw = localStorage.getItem('workflowTrace');
                    list = raw ? JSON.parse(raw) : [];
                } catch (e) {
                    list = [];
                }
                if (!Array.isArray(list) || list.length === 0) {
                    host.innerHTML = '<div style="color:#546e7a; font-size:0.85em;">Noch keine Events.</div>';
                    return;
                }

                const items = list.slice(-10).reverse();
                host.innerHTML = items.map((it) => {
                    const when = (it.ts || '').replace('T', ' ').slice(0, 19);
                    const label = `${when} — ${it.cur || '—'} → ${it.nxt || '—'}`;
                    const rawHref = it.page || '/';
                    let safeHref = rawHref;
                    try {
                        const u = new URL(rawHref, window.location.origin);
                        const postToGetMap = {
                            '/set_student': '/',
                            '/kis/register_patient': '/',
                            '/create_order': '/',
                            '/echo': '/',
                            '/retrieve': '/viewer',
                            '/workstation/report': '/viewer',
                        };
                        if (postToGetMap[u.pathname]) safeHref = postToGetMap[u.pathname];
                    } catch (e) {
                        // ignore
                    }
                    return `<button type="button" data-href="${safeHref}" style="width:100%; text-align:left; border:1px solid #cfd8dc; background:#fff; color:#263238; border-radius:8px; padding:6px 8px; margin:4px 0; cursor:pointer;">${label}</button>`;
                }).join('');

                host.querySelectorAll('button[data-href]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const href = btn.getAttribute('data-href');
                        if (href) window.location.href = href;
                    });
                });
            }

            function workflowBindStepButtons() {
                const map = {
                    '1': '/',
                    '2': '/',
                    '3': '/',
                    '4': '/modality',
                    '5': '/modality',
                    '6': '/viewer',
                    '7': '/viewer',
                };
                document.querySelectorAll('[data-wf-step]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const step = btn.getAttribute('data-wf-step') || '';
                        const href = map[step] || '/';
                        try { localStorage.setItem('workflowDrawerOpen', '1'); } catch (e) {}
                        window.location.href = href;
                    });
                });
            }

            const _setWorkflowUiOriginal = setWorkflowUi;
            setWorkflowUi = function(currentText, nextText, activeNode, nextNode) {
                _setWorkflowUiOriginal(currentText, nextText, activeNode, nextNode);
                workflowTraceAdd(currentText, nextText, activeNode, nextNode);
                workflowTraceRender();
            };
        </script>
</head>
<body>
    <a href="/" class="back-btn">&larr; Zurück zum Hauptmenü</a>
    
    <h1>Radiologe / Workstation</h1>
    <p>Hier simulieren wir eine Befundungs-Workstation, die Bilder vom PACS abruft (Query/Retrieve).</p>
    {% if student_code %}
    <p class="protocol-note">Aktiver SuS-Code: <strong>{{ student_code }}</strong> (gefilterte Ansicht)</p>
    {% endif %}

    <input id="workflowDrawer" class="workflow-drawer-toggle" type="checkbox">
    <label class="workflow-drawer-button" for="workflowDrawer">Workflow</label>
    <aside class="workflow-drawer" aria-label="Workflow">
        <header>
            <div>
                <div class="workflow-drawer-title">Workflow</div>
                <div id="workflowSteps" class="workflow-steps">Aktuell: {{ workflow_current or '—' }} | Als nächstes: {{ workflow_next or '—' }}</div>
            </div>
            <label class="workflow-drawer-close" for="workflowDrawer">Schliessen</label>
        </header>
        <div class="workflow-diagram">
            <template id="workflowGraphBase">
flowchart TB
    classDef system fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000
    classDef backend fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef hl7 fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef dicom fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef active stroke:#000,stroke-width:4px
    classDef next stroke-dasharray: 6 3

    KIS["KIS"]
    RIS["RIS"]
    LIS["LIS"]
    MWLServer["MWL"]
    Modality["CT"]
    PACS["PACS"]
    Workstation["Workstation"]

    ADT["1. HL7 ADT"]
    ORU["2. HL7 ORU"]
    ORM["3. HL7 ORM"]
    MWL["4. DICOM C-FIND (MWL)"]
    STORE["5. DICOM C-STORE"]
    QFIND["6. DICOM C-FIND (Study)"]
    CMOVE["7. DICOM C-MOVE"]

    class KIS,RIS,LIS,Modality,Workstation system
    class MWLServer,PACS backend
    class ADT,ORU,ORM hl7
    class MWL,STORE,QFIND,CMOVE dicom

    KIS -.-> ADT -.-> RIS
    RIS -.-> ORU -.-> LIS
    RIS -.-> ORM -.-> MWLServer
    MWLServer --> MWL --> Modality
    Modality --> STORE --> PACS
    Workstation --> QFIND --> PACS
    Workstation --> CMOVE --> PACS

    click KIS workflowExplain "KIS"
    click RIS workflowExplain "RIS"
    click LIS workflowExplain "LIS"
    click MWLServer workflowExplain "MWL"
    click Modality workflowExplain "CT"
    click PACS workflowExplain "PACS"
    click Workstation workflowExplain "Workstation"
    click ADT workflowExplain "HL7 ADT"
    click ORU workflowExplain "HL7 ORU"
    click ORM workflowExplain "HL7 ORM"
    click MWL workflowExplain "DICOM MWL"
    click STORE workflowExplain "DICOM C-STORE"
    click QFIND workflowExplain "DICOM C-FIND"
    click CMOVE workflowExplain "DICOM C-MOVE"
            </template>

            <div id="workflowMermaid" class="mermaid"></div>

            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;">
                <button type="button" data-wf-step="1" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">1</button>
                <button type="button" data-wf-step="2" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">2</button>
                <button type="button" data-wf-step="3" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">3</button>
                <button type="button" data-wf-step="4" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">4</button>
                <button type="button" data-wf-step="5" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">5</button>
                <button type="button" data-wf-step="6" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">6</button>
                <button type="button" data-wf-step="7" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">7</button>
            </div>

            <div id="workflowExplainPanel" style="display:none; margin-top:10px; padding:10px; border-radius:10px; border:1px solid #eceff1; background:#fafafa;"></div>

            <div style="margin-top:10px;">
                <div style="font-weight:700; margin-bottom:6px;">Trace</div>
                <div id="workflowTrace"></div>
            </div>

            <script type="application/json" id="workflowStateJson">{{ {'current': workflow_current or '', 'next': workflow_next or ''}|tojson }}</script>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    workflowBindStepButtons();
                    workflowTraceRender();
                    const stateEl = document.getElementById('workflowStateJson');
                    const state = stateEl ? JSON.parse(stateEl.textContent || '{}') : { current: '', next: '' };
                    const cur = String(state.current || '');
                    const nxt = String(state.next || '');

                    if (cur && cur.toLowerCase().includes('retrieve')) {
                        setWorkflowUi(cur || '7. DICOM C-MOVE', nxt || '—', 'CMOVE', null);
                    } else {
                        setWorkflowUi(cur || '6. DICOM C-FIND (Study)', nxt || '7. DICOM C-MOVE', 'QFIND', 'CMOVE');
                    }
                });
            </script>
        </div>
    </aside>
    
    {% if msg %}
    <div style="padding: 10px; background: #eee; border-left: 5px solid #333;">{{ msg }}</div>
    {% endif %}

    <div class="section">
        <h2>6. DICOM C-FIND (Study Root): Studien suchen</h2>
        <p>Suche nach allen Studien im PACS (Orthanc).</p>

        <div class="protocol-note" style="margin-top:6px;">
            ℹ️ <strong>Merke:</strong> <code>C-FIND</code> = Liste holen (Query). <code>C-MOVE</code> = <em>Retrieve anfordern</em> — danach sendet das PACS die Bilder aktiv per <code>C-STORE</code> an diese Workstation.
        </div>
        
        {% if studies %}
        <div style="max-height: 55vh; overflow: auto; border: 1px solid #ddd; border-radius: 8px; background: white;">
            <table style="margin-top:0;">
                <thead>
                    <tr>
                        <th>Patientenname</th>
                        <th>Patienten-ID</th>
                        <th>Studien-Datum</th>
                        <th>Modalität</th>
                        <th>Aktion</th>
                        <th>Viewer</th>
                    </tr>
                </thead>
                <tbody>
                    {% for study in studies %}
                    {% set can_open = moved_studies and (study.StudyInstanceUID in moved_studies) %}
                    <tr>
                        <td>{{ study.PatientName }}</td>
                        <td>{{ study.PatientID }}</td>
                        <td>{{ study.StudyDate }}</td>
                        <td>{{ study.ModalitiesInStudy }}</td>
                        <td>
                            <form action="/retrieve" method="post" style="display:inline;">
                                <input type="hidden" name="study_uid" value="{{ study.StudyInstanceUID }}">
                                <button type="submit">Retrieve anfordern (C-MOVE)</button>
                            </form>
                            <div class="protocol-note" style="margin-top:6px;">
                                Schritt 7: Workstation sagt dem PACS „schick mir diese Studie“. Das PACS startet dann <code>C-STORE</code> zurück zur Workstation (siehe Cache unten).
                            </div>
                        </td>
                        <td style="white-space: nowrap;">
                            {% if can_open %}
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="/pacs/open_by_uid?study_uid={{ study.StudyInstanceUID }}"><button type="button" style="background:#1565c0;">Öffnen</button></a>
                                    <a href="/pacs/open_first_instance_by_uid?study_uid={{ study.StudyInstanceUID }}"><button type="button" style="background:#455a64;">Metadaten</button></a>
                                </div>
                            {% else %}
                                <div class="protocol-note">Erst <code>C-MOVE</code> anfordern, dann öffnen.</div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <button type="button" disabled style="background:#9e9e9e; cursor:not-allowed;">Öffnen</button>
                                    <button type="button" disabled style="background:#9e9e9e; cursor:not-allowed;">Metadaten</button>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p><i>Keine Studien im PACS gefunden oder Verbindungsproblem.</i></p>
        <p><a href="/viewer"><button>Aktualisieren (Suchen)</button></a></p>
        {% endif %}
        
        <div class="protocol-note">
            ℹ️ <strong>Hintergrund:</strong> Die Workstation sendet <code>DICOM C-FIND</code> (Study Root Information Model) an das PACS, um eine Liste verfügbarer Studien zu erhalten.
        </div>
    </div>

    <div class="section cache">
        <h2>7. DICOM C-MOVE: Retrieve + Empfang (C-STORE)</h2>
        <p>Bilder, die erfolgreich per C-MOVE angefordert und vom PACS per C-STORE an diese Workstation übertragen wurden.</p>

        <div class="protocol-note" style="margin-top:6px;">
            ℹ️ Falls nach dem Anfordern noch nichts erscheint: kurz warten und dann oben die Studienliste oder diese Seite aktualisieren. Der Transfer läuft asynchron.
        </div>

        <div class="protocol-note" style="margin-top:10px;">
            <strong>Optional (nach Schritt 7): HL7 ORU^R01 – Befundung (Workstation → RIS)</strong><br>
            Der Befund wird typischerweise erst <em>nachdem</em> Bilder empfangen wurden erstellt. (Nicht zu verwechseln mit Schritt 2: ORU-Laborwert aus dem LIS.)
        </div>

        {% set received_studies = received_studies|default([]) %}
        {% if received_studies and received_studies|length > 0 %}
            <div style="margin-top:10px;">
                <div style="font-weight:700; margin-bottom:6px;">Empfangene Studien (gruppiert)</div>
                <table>
                    <thead>
                        <tr>
                            <th>Letzter Empfang</th>
                            <th>Patient</th>
                            <th>Modalitäten</th>
                            <th>Anzahl Instanzen</th>
                            <th>StudyInstanceUID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in received_studies %}
                            <tr>
                                <td>{{ s.LastTimestamp }}</td>
                                <td>{{ s.PatientName }} ({{ s.PatientID }})</td>
                                <td>{{ s.Modalities }}</td>
                                <td>{{ s.Count }}</td>
                                <td style="font-family: monospace;">{{ s.StudyInstanceUID }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <form action="/workstation/report" method="post" style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Empfangene Studie</label>
                    <select name="study_uid" required style="padding:8px; border:1px solid #ddd; border-radius:6px; min-width: 320px;">
                        {% for s in received_studies %}
                            <option value="{{ s.StudyInstanceUID }}">{{ s.PatientName }} ({{ s.PatientID }}) — {{ s.Modalities }} — {{ s.Count }} Instanzen</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex:1; min-width: 320px;">
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Befundtext (Kurz)</label>
                    <textarea name="report_text" rows="3" placeholder="z.B. Kein Hinweis auf akute Blutung. ..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></textarea>
                </div>
                <div>
                    <button type="submit">Befund senden (HL7 ORU^R01)</button>
                </div>
            </form>
        {% else %}
            <div class="protocol-note" style="margin-top:8px;">
                Erst Bilder empfangen (C-STORE), dann Befund möglich.
            </div>
        {% endif %}

        {% if last_workstation_oru_hl7 %}
            <div style="margin-top:10px;">
                <div style="font-weight:700; margin-bottom:6px;">Letzte HL7 ORU^R01 Nachricht (Workstation → RIS)</div>
                <pre style="white-space:pre-wrap; background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px;">{{ last_workstation_oru_hl7 }}</pre>
            </div>
        {% endif %}

        {% set reports = reports|default([]) %}
        {% if reports and reports|length > 0 %}
            <div style="margin-top:10px;">
                <div style="font-weight:700; margin-bottom:6px;">Gespeicherte Befunde (pro SuS-Code)</div>
                <table>
                    <thead>
                        <tr>
                            <th>Zeitpunkt</th>
                            <th>Patient</th>
                            <th>StudyInstanceUID</th>
                            <th>Text</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in reports|reverse %}
                            <tr>
                                <td>{{ r.created_at }}</td>
                                <td>{{ r.PatientName }} ({{ r.PatientID }})</td>
                                <td style="font-family: monospace;">{{ r.StudyInstanceUID }}</td>
                                <td>{{ r.text }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
        
        <table>
            <thead>
                <tr>
                    <th>Zeitpunkt</th>
                    <th>Patient</th>
                    <th>Modalität</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for img in received %}
                <tr>
                    <td>{{ img.Timestamp }}</td>
                    <td>{{ img.PatientName }}</td>
                    <td>{{ img.Modality }}</td>
                    <td>✅ Empfangen (C-STORE SCP)</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="protocol-note">
            ℹ️ <strong>Hintergrund C-MOVE:</strong>
            <ol>
                <li>Workstation sendet <code>C-MOVE Request</code> an PACS: "Bitte sende Studie X an mich (AE Title: SIMULATOR)".</li>
                <li>PACS baut <strong>neue Verbindung</strong> zur Workstation auf.</li>
                <li>PACS sendet Bilder via <code>C-STORE</code> an den Listener der Workstation.</li>
                <li>Workstation speichert die Bilder lokal (hier: zeigt sie in der Liste an).</li>
            </ol>
        </div>
    </div>

</body>
</html>
