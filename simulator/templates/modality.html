<!DOCTYPE html>
<html lang="de">
<head>
    <title>CT Konsole - Modality Worklist (DICOM C-FIND)</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { background: #e0f7fa; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .workflow { background: #fff; border: 1px solid #cfd8dc; padding: 12px; margin-bottom: 20px; border-radius: 5px; }
        .workflow small { color: #546e7a; }
        .workflow-steps { color: #546e7a; font-weight: 400; font-size: 0.85em; }
        .workflow-diagram { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eceff1; flex: 1 1 auto; min-height: 0; overflow: auto; }
        .workflow-diagram svg { width: 100%; height: auto; }
        .workflow-drawer-toggle { position: absolute; left: -9999px; }
        .workflow-drawer-button {
            position: fixed;
            right: 0;
            top: 140px;
            z-index: 100;
            background: #fff;
            border: 1px solid #cfd8dc;
            border-right: none;
            padding: 10px 12px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .workflow-drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(520px, 90vw);
            z-index: 99;
            background: #fff;
            border-left: 1px solid #cfd8dc;
            padding: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateX(105%);
            transition: transform 160ms ease-in-out;
        }
        .workflow-drawer header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid #eceff1;
            padding-bottom: 8px;
            margin-bottom: 8px;
            flex: 0 0 auto;
        }
        .workflow-drawer-title { font-weight: 700; }
        .workflow-drawer-close {
            cursor: pointer;
            border: 1px solid #cfd8dc;
            padding: 4px 8px;
            border-radius: 6px;
            background: #fff;
        }
        #workflowDrawer:checked ~ .workflow-drawer { transform: translateX(0); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        button { background: #ff9800; color: white; border: none; padding: 8px 12px; cursor: pointer; }
        button:hover { background: #e65100; }
        .back-btn { background: #757575; margin-bottom: 20px; padding: 10px 15px; text-decoration: none; display: inline-block; color: white;}
        .protocol-note { font-size: 0.85em; color: #455a64; font-style: italic; margin-top: 10px; }
        .msg { padding: 10px; background: #fff3e0; border-left: 5px solid #ff9800; margin: 15px 0; }
        input[type="file"] { width: 100%; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
            mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
    </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const checkbox = document.getElementById('workflowDrawer');
                if (!checkbox) return;
                const storageKey = 'workflowDrawerOpen';
                checkbox.checked = localStorage.getItem(storageKey) === '1';
                checkbox.addEventListener('change', () => {
                    localStorage.setItem(storageKey, checkbox.checked ? '1' : '0');
                });
            });
        </script>
        <script>
            function renderWorkflow(activeNode, nextNode) {
                const base = document.getElementById('workflowGraphBase');
                const mermaidDiv = document.getElementById('workflowMermaid');
                if (!base || !mermaidDiv || !window.mermaid) return;

                let highlight = '';
                if (activeNode) highlight += `\n  class ${activeNode} active`;
                if (nextNode) highlight += `\n  class ${nextNode} next`;

                mermaidDiv.removeAttribute('data-processed');
                mermaidDiv.innerHTML = base.innerHTML.trim() + highlight + "\n";

                try {
                    if (typeof window.mermaid.run === 'function') {
                        window.mermaid.run({ nodes: [mermaidDiv] });
                    } else if (typeof window.mermaid.init === 'function') {
                        window.mermaid.init(undefined, mermaidDiv);
                    }
                } catch (e) {
                    // Ignore rendering errors; the UI still works without the diagram.
                }
            }

            function setWorkflowUi(currentText, nextText, activeNode, nextNode) {
                const steps = document.getElementById('workflowSteps');
                if (steps) {
                    steps.textContent = `Aktuell: ${currentText || '—'} | Als nächstes: ${nextText || '—'}`;
                }
                renderWorkflow(activeNode, nextNode);
            }

            function workflowExplain(nodeId) {
                const explain = {
                    KIS: { title: 'KIS', text: 'Patientenaufnahme / Stammdaten. Von hier kommen typischerweise HL7 ADT Events.' },
                    LIS: { title: 'LIS', text: 'Labor-System. Liefert z.B. Kreatinin als HL7 ORU Resultat.' },
                    RIS: { title: 'RIS', text: 'Radiologie-Informationssystem. Auftrag/Order (HL7 ORM) und Worklist.' },
                    MWLServer: { title: 'MWL', text: 'DICOM Modality Worklist (SCP). Modalitäten fragen hier die Arbeitsliste ab.' },
                    Modality: { title: 'CT', text: 'Modalität (CT Konsole). Ruft MWL ab und sendet Bilder via DICOM C-STORE.' },
                    PACS: { title: 'PACS', text: 'PACS/Archiv. Speichert DICOM und liefert Query/Retrieve.' },
                    Workstation: { title: 'Workstation', text: 'Befundungs-Workstation. Sucht Studien (C-FIND) und holt sie (C-MOVE).' },
                    ADT: { title: '1. HL7 ADT', text: 'ADT = Aufnahme/Patientenstammdaten (Admission/Discharge/Transfer).' },
                    ORU: { title: '2. HL7 ORU', text: 'ORU = Befund/Resultat (Observation Result). Hier: Kreatinin aus dem LIS.' },
                    ORM: { title: '3. HL7 ORM', text: 'ORM = Auftrag/Order (Order Message). Hier: RIS erstellt radiologischen Auftrag.' },
                    MWL: { title: '4. DICOM C-FIND (MWL)', text: 'CT fragt geplante Untersuchungen ab (Worklist Pull).' },
                    STORE: { title: '5. DICOM C-STORE', text: 'Modalität sendet Bilder/Instanzen an das PACS.' },
                    QFIND: { title: '6. DICOM C-FIND (Study)', text: 'Workstation sucht Studien im PACS (Study Root Query).' },
                    CMOVE: { title: '7. DICOM C-MOVE', text: 'Workstation holt Studie. PACS sendet Instanzen an den Empfänger (Store SCP).' },
                };

                const key = String(nodeId || '').trim();
                const info = explain[key];
                const panel = document.getElementById('workflowExplainPanel');
                if (!panel) return;

                if (!info) {
                    panel.style.display = 'none';
                    panel.innerHTML = '';
                    return;
                }

                panel.style.display = 'block';
                panel.innerHTML = `<div style="font-weight:700; margin-bottom:4px;">${info.title}</div><div>${info.text}</div>`;

                const checkbox = document.getElementById('workflowDrawer');
                if (checkbox) checkbox.checked = true;
                try { localStorage.setItem('workflowDrawerOpen', '1'); } catch (e) {}
            }

            function workflowTraceAdd(currentText, nextText, activeNode, nextNode) {
                const entry = {
                    ts: new Date().toISOString(),
                    page: window.location.pathname + window.location.search,
                    cur: currentText || '',
                    nxt: nextText || '',
                    a: activeNode || '',
                    n: nextNode || '',
                };

                try {
                    const key = 'workflowTrace';
                    const raw = localStorage.getItem(key);
                    const list = raw ? JSON.parse(raw) : [];
                    const last = Array.isArray(list) && list.length ? list[list.length - 1] : null;
                    const same = last && last.cur === entry.cur && last.nxt === entry.nxt && last.a === entry.a && last.n === entry.n && last.page === entry.page;
                    if (!same) {
                        const next = Array.isArray(list) ? list : [];
                        next.push(entry);
                        while (next.length > 20) next.shift();
                        localStorage.setItem(key, JSON.stringify(next));
                    }
                } catch (e) {
                    // ignore
                }
            }

            function workflowTraceRender() {
                const host = document.getElementById('workflowTrace');
                if (!host) return;
                let list = [];
                try {
                    const raw = localStorage.getItem('workflowTrace');
                    list = raw ? JSON.parse(raw) : [];
                } catch (e) {
                    list = [];
                }
                if (!Array.isArray(list) || list.length === 0) {
                    host.innerHTML = '<div style="color:#546e7a; font-size:0.85em;">Noch keine Events.</div>';
                    return;
                }

                const items = list.slice(-10).reverse();
                host.innerHTML = items.map((it) => {
                    const when = (it.ts || '').replace('T', ' ').slice(0, 19);
                    const label = `${when} — ${it.cur || '—'} → ${it.nxt || '—'}`;
                    const href = it.page || '/';
                    return `<button type="button" data-href="${href}" style="width:100%; text-align:left; border:1px solid #cfd8dc; background:#fff; border-radius:8px; padding:6px 8px; margin:4px 0; cursor:pointer;">${label}</button>`;
                }).join('');

                host.querySelectorAll('button[data-href]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const href = btn.getAttribute('data-href');
                        if (href) window.location.href = href;
                    });
                });
            }

            function workflowBindStepButtons() {
                const map = {
                    '1': '/',
                    '2': '/',
                    '3': '/',
                    '4': '/modality',
                    '5': '/modality',
                    '6': '/viewer',
                    '7': '/viewer',
                };
                document.querySelectorAll('[data-wf-step]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const step = btn.getAttribute('data-wf-step') || '';
                        const href = map[step] || '/';
                        try { localStorage.setItem('workflowDrawerOpen', '1'); } catch (e) {}
                        window.location.href = href;
                    });
                });
            }

            // Wrap original setter to also log + render trace.
            const _setWorkflowUiOriginal = setWorkflowUi;
            setWorkflowUi = function(currentText, nextText, activeNode, nextNode) {
                _setWorkflowUiOriginal(currentText, nextText, activeNode, nextNode);
                workflowTraceAdd(currentText, nextText, activeNode, nextNode);
                workflowTraceRender();
            };
        </script>
</head>
<body>
    <a href="/" class="back-btn">&larr; Zurück zur Verwaltung (KIS/LIS/RIS)</a>
    
    <h1>Modalität (CT Konsole)</h1>
    <p>Dieser Simulator simuliert eine CT-Konsole, die soeben eine <code>DICOM C-FIND</code> Anfrage an das RIS/PACS (Orthanc MWL SCP) gestellt hat, um die "Geplanten Untersuchungen" (Scheduled Procedure Steps) abzurufen.</p>

    <input id="workflowDrawer" class="workflow-drawer-toggle" type="checkbox">
    <label class="workflow-drawer-button" for="workflowDrawer">Workflow</label>
    <aside class="workflow-drawer" aria-label="Workflow">
        <header>
            <div>
                <div class="workflow-drawer-title">Workflow</div>
                <div id="workflowSteps" class="workflow-steps">Aktuell: {{ workflow_current or '—' }} | Als nächstes: {{ workflow_next or '—' }}</div>
            </div>
            <label class="workflow-drawer-close" for="workflowDrawer">Schliessen</label>
        </header>
        <div class="workflow-diagram">
            <template id="workflowGraphBase">
flowchart TB
    classDef system fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000
    classDef backend fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef hl7 fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef dicom fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef active stroke:#000,stroke-width:4px
    classDef next stroke-dasharray: 6 3

    KIS["KIS"]
    RIS["RIS"]
    LIS["LIS"]
    MWLServer["MWL"]
    Modality["CT"]
    PACS["PACS"]
    Workstation["Workstation"]

    ADT["1. HL7 ADT"]
    ORU["2. HL7 ORU"]
    ORM["3. HL7 ORM"]
    MWL["4. DICOM C-FIND (MWL)"]
    STORE["5. DICOM C-STORE"]
    QFIND["6. DICOM C-FIND (Study)"]
    CMOVE["7. DICOM C-MOVE"]

    class KIS,RIS,LIS,Modality,Workstation system
    class MWLServer,PACS backend
    class ADT,ORU,ORM hl7
    class MWL,STORE,QFIND,CMOVE dicom

    KIS -.-> ADT -.-> RIS
    RIS -.-> ORU -.-> LIS
    RIS -.-> ORM -.-> MWLServer
    MWLServer --> MWL --> Modality
    Modality --> STORE --> PACS
    Workstation --> QFIND --> PACS
    Workstation --> CMOVE --> PACS

    click KIS workflowExplain "KIS"
    click RIS workflowExplain "RIS"
    click LIS workflowExplain "LIS"
    click MWLServer workflowExplain "MWL"
    click Modality workflowExplain "CT"
    click PACS workflowExplain "PACS"
    click Workstation workflowExplain "Workstation"
    click ADT workflowExplain "HL7 ADT"
    click ORU workflowExplain "HL7 ORU"
    click ORM workflowExplain "HL7 ORM"
    click MWL workflowExplain "DICOM MWL"
    click STORE workflowExplain "DICOM C-STORE"
    click QFIND workflowExplain "DICOM C-FIND"
    click CMOVE workflowExplain "DICOM C-MOVE"
            </template>

            <div id="workflowMermaid" class="mermaid"></div>

            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;">
                <button type="button" data-wf-step="1" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">1</button>
                <button type="button" data-wf-step="2" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">2</button>
                <button type="button" data-wf-step="3" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">3</button>
                <button type="button" data-wf-step="4" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">4</button>
                <button type="button" data-wf-step="5" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">5</button>
                <button type="button" data-wf-step="6" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">6</button>
                <button type="button" data-wf-step="7" style="border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:4px 10px; cursor:pointer;">7</button>
            </div>

            <div id="workflowExplainPanel" style="display:none; margin-top:10px; padding:10px; border-radius:10px; border:1px solid #eceff1; background:#fafafa;"></div>

            <div style="margin-top:10px;">
                <div style="font-weight:700; margin-bottom:6px;">Trace</div>
                <div id="workflowTrace"></div>
            </div>

            <script type="application/json" id="workflowStateJson">{{ {'current': workflow_current or '', 'next': workflow_next or ''}|tojson }}</script>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    workflowBindStepButtons();
                    workflowTraceRender();
                    const stateEl = document.getElementById('workflowStateJson');
                    const state = stateEl ? JSON.parse(stateEl.textContent || '{}') : { current: '', next: '' };
                    const cur = String(state.current || '');
                    const nxt = String(state.next || '');

                    if (cur && cur.toLowerCase().includes('bilder senden')) {
                        setWorkflowUi(cur || '5. DICOM C-STORE', nxt || '6. DICOM C-FIND (Study)', 'STORE', 'QFIND');
                    } else {
                        setWorkflowUi(cur || '4. DICOM C-FIND (MWL)', nxt || '5. DICOM C-STORE', 'MWL', 'STORE');
                    }
                });
            </script>
        </div>
    </aside>

        {% if msg %}
            <div class="msg">{{ msg }}</div>
        {% endif %}


    <div class="section">
        <h2>HL7 ORM Nachricht (Order Entry)</h2>
        <p>Der Simulator hat implizit folgende HL7-Nachricht empfangen:</p>
        <pre style="background: #333; color: #0f0; padding: 10px; border-radius: 5px; font-family: monospace; overflow-x: auto;">
MSH|^~\&|KEL|RIS|CT|MOD|202310101010||ORM^O01|MSG00001|P|2.3
PID|||{{ items[0].PatientID if items else '12345' }}||{{ items[0].PatientName if items else 'DOE^JOHN' }}||19800101|M
pV1||O|OP^^^|
ORC|NW|{{ items[0].AccessionNumber if items else 'ACC001' }}|||||^^^202310101010
OBR|1|{{ items[0].AccessionNumber if items else 'ACC001' }}||CT^CT Abdomen|||202310101010
        </pre>
        <div class="protocol-note">
            ℹ️ Dies ist ein vereinfachtes Beispiel einer <strong>ORM^O01</strong> Nachricht, die vom KIS an das RIS gesendet wird, um die Worklist zu befüllen.
        </div>
    </div>
    
    <div class="section">
        <h2>Arbeitsliste (Worklist Query - C-FIND)</h2>
        {% if items %}
        <table>
            <thead>
                <tr>
                    <th>Patientenname</th>
                    <th>Patienten-ID</th>
                    <th>Auftragsnr. (Accession #)</th>
                    <th>Untersuchung</th>
                    <th>Aktion</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ item.PatientName }}</td>
                    <td>{{ item.PatientID }}</td>
                    <td>{{ item.AccessionNumber }}</td>
                    <td>{{ item.RequestedProcedureDescription }}</td>
                    <td>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                            <a href="/pacs?acc={{ item.AccessionNumber }}"><button type="button" style="background:#1565c0;">PACS Viewer (SuS)</button></a>
                        </div>

                        <form action="/scan" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="name" value="{{ item.PatientName }}">
                            <input type="hidden" name="pid" value="{{ item.PatientID }}">
                            <input type="hidden" name="acc" value="{{ item.AccessionNumber }}">

                            <label style="font-size:0.9em; display:block; margin-bottom:6px;">Echte CT-Daten hochladen (ZIP oder mehrere DICOM-Dateien):</label>
                            <input type="file" name="dicom_files" multiple required>

                                                        <div class="protocol-note" style="margin-top:6px;">
                                                            ℹ️ Hinweis: Nutzen Sie für die Lehre möglichst anonymisierte DICOM-Daten. Falls "Metadaten anpassen" aktiviert ist, werden Patient/Accession/StudyUID auf diesen Auftrag gesetzt.
                                                        </div>

                            <label style="font-size:0.9em; display:block; margin-top:6px;">
                              <input type="checkbox" name="retag" checked>
                              Metadaten an diesen Worklist-Eintrag anpassen (Patient/Accession/StudyUID)
                            </label>

                            <button type="submit" style="margin-top:8px;">DICOM UPLOAD & C-STORE senden</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="protocol-note">
            ℹ️ <strong>Hintergrund DICOM C-FIND:</strong> Query/Retrieve Service Class. Erlaubt "Client" (hier: CT) eine Liste von Attributen vom "Server" (hier: RIS/PACS) abzurufen.<br>
            Sobald Sie auf "SCANNEN" klicken, passiert Folgendes:
            <ul>
                <li><strong>DICOM C-STORE:</strong> Das Gerät pusht die Bilder zum PACS (Storage Service Class).</li>
                <li><strong>DICOM C-MOVE / C-GET:</strong> Eine Workstation würde diese verwenden, um die Bilder abzurufen (Retrieve). Hier sehen wir sie direkt im PACS (Orthanc Web Viewer).</li>
            </ul>
        </div>
        {% else %}
        <p>Keine geplanten Untersuchungen auf der DICOM Worklist gefunden.</p>
        <p><i>Haben Sie im RIS bereits einen Auftrag freigegeben?</i></p>
        {% endif %}
    </div>
</body>
</html>
