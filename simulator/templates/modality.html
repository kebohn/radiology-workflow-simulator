<!DOCTYPE html>
<html lang="de">
<head>
    <title>CT Konsole - Modality Worklist (DICOM C-FIND)</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { background: #e0f7fa; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .workflow { background: #fff; border: 1px solid #cfd8dc; padding: 12px; margin-bottom: 20px; border-radius: 5px; }
        .workflow small { color: #546e7a; }
        .workflow-steps { color: #546e7a; font-weight: 400; font-size: 0.85em; }
        .workflow-diagram { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eceff1; flex: 1 1 auto; min-height: 0; overflow: hidden; }
        .workflow-diagram svg { width: 100%; height: 100%; }
        .workflow-drawer-toggle { position: absolute; left: -9999px; }
        .workflow-drawer-button {
            position: fixed;
            right: 0;
            top: 140px;
            z-index: 100;
            background: #fff;
            border: 1px solid #cfd8dc;
            border-right: none;
            padding: 10px 12px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .workflow-drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(520px, 90vw);
            z-index: 99;
            background: #fff;
            border-left: 1px solid #cfd8dc;
            padding: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateX(105%);
            transition: transform 160ms ease-in-out;
        }
        .workflow-drawer header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid #eceff1;
            padding-bottom: 8px;
            margin-bottom: 8px;
            flex: 0 0 auto;
        }
        .workflow-drawer-title { font-weight: 700; }
        .workflow-drawer-close {
            cursor: pointer;
            border: 1px solid #cfd8dc;
            padding: 4px 8px;
            border-radius: 6px;
            background: #fff;
        }
        #workflowDrawer:checked ~ .workflow-drawer { transform: translateX(0); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        button { background: #ff9800; color: white; border: none; padding: 8px 12px; cursor: pointer; }
        button:hover { background: #e65100; }
        .back-btn { background: #757575; margin-bottom: 20px; padding: 10px 15px; text-decoration: none; display: inline-block; color: white;}
        .protocol-note { font-size: 0.85em; color: #455a64; font-style: italic; margin-top: 10px; }
        .msg { padding: 10px; background: #fff3e0; border-left: 5px solid #ff9800; margin: 15px 0; }
        input[type="file"] { width: 100%; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
    </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const checkbox = document.getElementById('workflowDrawer');
                if (!checkbox) return;
                const storageKey = 'workflowDrawerOpen';
                checkbox.checked = localStorage.getItem(storageKey) === '1';
                checkbox.addEventListener('change', () => {
                    localStorage.setItem(storageKey, checkbox.checked ? '1' : '0');
                });
            });
        </script>
</head>
<body>
    <a href="/" class="back-btn">&larr; Zur√ºck zur Verwaltung (KIS/LIS/RIS)</a>
    
    <h1>Modalit√§t (CT Konsole)</h1>
    <p>Dieser Simulator simuliert eine CT-Konsole, die soeben eine <code>DICOM C-FIND</code> Anfrage an das RIS/PACS (Orthanc MWL SCP) gestellt hat, um die "Geplanten Untersuchungen" (Scheduled Procedure Steps) abzurufen.</p>

    <input id="workflowDrawer" class="workflow-drawer-toggle" type="checkbox">
    <label class="workflow-drawer-button" for="workflowDrawer">Workflow</label>
    <aside class="workflow-drawer" aria-label="Workflow">
        <header>
            <div>
                <div class="workflow-drawer-title">Workflow</div>
                <div class="workflow-steps">Aktuell: {{ workflow_current or '‚Äî' }} | Als n√§chstes: {{ workflow_next or '‚Äî' }}</div>
            </div>
            <label class="workflow-drawer-close" for="workflowDrawer">Schliessen</label>
        </header>
        <div class="workflow-diagram">
            <div class="mermaid">
flowchart TB
    classDef system fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000
    classDef backend fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef hl7 fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef dicom fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef active stroke:#000,stroke-width:4px
    classDef next stroke-dasharray: 6 3

    subgraph Verwaltung["üè• Verwaltung"]
        direction LR
        KIS["KIS"]
        RIS["RIS"]
        LIS["LIS"]
    end

    subgraph Backend["üíæ Orthanc"]
        direction LR
        MWLServer["MWL"]
        PACS["PACS"]
    end

    Modality["CT"]
    Workstation["Workstation"]

    ADT["HL7 ADT"]
    ORU["HL7 ORU"]
    ORM["HL7 ORM"]
    MWL["DICOM C-FIND (MWL)"]
    STORE["DICOM C-STORE"]
    QFIND["DICOM C-FIND (Study)"]
    CMOVE["DICOM C-MOVE"]
    WSSTORE["DICOM C-STORE (R√ºckkanal)"]

    class KIS,RIS,LIS,Modality,Workstation system
    class MWLServer,PACS backend
    class ADT,ORU,ORM hl7
    class MWL,STORE,QFIND,CMOVE,WSSTORE dicom

    KIS -.-> ADT -.-> RIS
    RIS -.-> ORU -.-> LIS
    RIS -.-> ORM -.-> MWLServer
    MWLServer --> MWL --> Modality
    Modality --> STORE --> PACS
    Workstation --> QFIND --> PACS
    Workstation --> CMOVE --> PACS
    PACS --> WSSTORE --> Workstation

    %% Highlight: CT-Konsole
    {% if workflow_current and 'Bilder senden' in workflow_current %}
    class STORE active
    class QFIND next
    {% else %}
    class MWL active
    class STORE next
    {% endif %}
                </div>
            </div>
        </div>
    </aside>

        {% if msg %}
            <div class="msg">{{ msg }}</div>
        {% endif %}


    <div class="section">
        <h2>HL7 ORM Nachricht (Order Entry)</h2>
        <p>Der Simulator hat implizit folgende HL7-Nachricht empfangen:</p>
        <pre style="background: #333; color: #0f0; padding: 10px; border-radius: 5px; font-family: monospace; overflow-x: auto;">
MSH|^~\&|KEL|RIS|CT|MOD|202310101010||ORM^O01|MSG00001|P|2.3
PID|||{{ items[0].PatientID if items else '12345' }}||{{ items[0].PatientName if items else 'DOE^JOHN' }}||19800101|M
pV1||O|OP^^^|
ORC|NW|{{ items[0].AccessionNumber if items else 'ACC001' }}|||||^^^202310101010
OBR|1|{{ items[0].AccessionNumber if items else 'ACC001' }}||CT^CT Abdomen|||202310101010
        </pre>
        <div class="protocol-note">
            ‚ÑπÔ∏è Dies ist ein vereinfachtes Beispiel einer <strong>ORM^O01</strong> Nachricht, die vom KIS an das RIS gesendet wird, um die Worklist zu bef√ºllen.
        </div>
    </div>
    
    <div class="section">
        <h2>Arbeitsliste (Worklist Query - C-FIND)</h2>
        {% if items %}
        <table>
            <thead>
                <tr>
                    <th>Patientenname</th>
                    <th>Patienten-ID</th>
                    <th>Auftragsnr. (Accession #)</th>
                    <th>Untersuchung</th>
                    <th>Aktion</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ item.PatientName }}</td>
                    <td>{{ item.PatientID }}</td>
                    <td>{{ item.AccessionNumber }}</td>
                    <td>{{ item.RequestedProcedureDescription }}</td>
                    <td>
                        <form action="/scan" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="name" value="{{ item.PatientName }}">
                            <input type="hidden" name="pid" value="{{ item.PatientID }}">
                            <input type="hidden" name="acc" value="{{ item.AccessionNumber }}">

                            <label style="font-size:0.9em; display:block; margin-bottom:6px;">Echte CT-Daten hochladen (ZIP oder mehrere DICOM-Dateien):</label>
                            <input type="file" name="dicom_files" multiple required>

                                                        <div class="protocol-note" style="margin-top:6px;">
                                                            ‚ÑπÔ∏è Hinweis: Nutzen Sie f√ºr die Lehre m√∂glichst anonymisierte DICOM-Daten. Falls "Metadaten anpassen" aktiviert ist, werden Patient/Accession/StudyUID auf diesen Auftrag gesetzt.
                                                        </div>

                            <label style="font-size:0.9em; display:block; margin-top:6px;">
                              <input type="checkbox" name="retag" checked>
                              Metadaten an diesen Worklist-Eintrag anpassen (Patient/Accession/StudyUID)
                            </label>

                            <button type="submit" style="margin-top:8px;">DICOM UPLOAD & C-STORE senden</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="protocol-note">
            ‚ÑπÔ∏è <strong>Hintergrund DICOM C-FIND:</strong> Query/Retrieve Service Class. Erlaubt "Client" (hier: CT) eine Liste von Attributen vom "Server" (hier: RIS/PACS) abzurufen.<br>
            Sobald Sie auf "SCANNEN" klicken, passiert Folgendes:
            <ul>
                <li><strong>DICOM C-STORE:</strong> Das Ger√§t pusht die Bilder zum PACS (Storage Service Class).</li>
                <li><strong>DICOM C-MOVE / C-GET:</strong> Eine Workstation w√ºrde diese verwenden, um die Bilder abzurufen (Retrieve). Hier sehen wir sie direkt im PACS (Orthanc Web Viewer).</li>
            </ul>
        </div>
        {% else %}
        <p>Keine geplanten Untersuchungen auf der DICOM Worklist gefunden.</p>
        <p><i>Haben Sie im RIS bereits einen Auftrag freigegeben?</i></p>
        {% endif %}
    </div>
</body>
</html>
